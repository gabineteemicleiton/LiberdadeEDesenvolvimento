<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Database - Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn {
            background: #1e40af;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .btn:hover {
            background: #1e3a8a;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .log {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status-success {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #16a34a;
        }
        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Setup Database Supabase</h1>
        <p>Configure as tabelas necess√°rias no seu banco Supabase.</p>
        
        <div id="statusContainer"></div>
        
        <button id="testConnection" class="btn">
            üîå Testar Conex√£o
        </button>
        
        <button id="createTables" class="btn btn-success">
            üöÄ Criar Todas as Tabelas
        </button>
        
        <button id="insertSampleData" class="btn">
            üìã Inserir Dados de Exemplo
        </button>
        
        <div id="logContainer" class="log" style="display: none;"></div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';
        
        const statusContainer = document.getElementById('statusContainer');
        const logContainer = document.getElementById('logContainer');
        const testConnectionBtn = document.getElementById('testConnection');
        const createTablesBtn = document.getElementById('createTables');
        const insertSampleDataBtn = document.getElementById('insertSampleData');

        function showStatus(message, type = 'success') {
            statusContainer.innerHTML = `
                <div class="status status-${type}">
                    <strong>${type === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${message}
                </div>
            `;
        }

        function addLog(message) {
            logContainer.style.display = 'block';
            logContainer.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function testConnection() {
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'üîÑ Testando...';
            
            try {
                addLog('Testando conex√£o com Supabase...');
                
                const { data, error } = await supabase
                    .from('_pg_stat_activity')
                    .select('*')
                    .limit(1);
                
                if (error && error.code !== '42P01') {
                    throw error;
                }
                
                addLog('‚úÖ Conectado ao Supabase com sucesso!');
                showStatus('Conex√£o estabelecida com sucesso!', 'success');
                
            } catch (error) {
                addLog('‚ùå Erro de conex√£o: ' + error.message);
                showStatus('Erro de conex√£o: ' + error.message, 'error');
            } finally {
                testConnectionBtn.disabled = false;
                testConnectionBtn.textContent = 'üîå Testar Conex√£o';
            }
        }

        async function createTables() {
            createTablesBtn.disabled = true;
            createTablesBtn.textContent = 'üîÑ Criando...';
            
            try {
                addLog('Iniciando cria√ß√£o das tabelas...');
                
                // Lista de comandos SQL para criar as tabelas
                const sqlCommands = [
                    // Tabela painel_site
                    `CREATE TABLE IF NOT EXISTS painel_site (
                        id SERIAL PRIMARY KEY,
                        title VARCHAR(255),
                        subtitle VARCHAR(255),
                        about_text TEXT,
                        contact_whatsapp VARCHAR(20),
                        contact_email VARCHAR(255),
                        banner_image_url VARCHAR(500),
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // Tabela agenda_publica
                    `CREATE TABLE IF NOT EXISTS agenda_publica (
                        id SERIAL PRIMARY KEY,
                        titulo TEXT NOT NULL,
                        descricao TEXT,
                        data TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // Tabela mandatos
                    `CREATE TABLE IF NOT EXISTS mandatos (
                        id SERIAL PRIMARY KEY,
                        titulo TEXT NOT NULL,
                        descricao TEXT,
                        imagem_url TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // Tabela projetos
                    `CREATE TABLE IF NOT EXISTS projetos (
                        id SERIAL PRIMARY KEY,
                        titulo TEXT NOT NULL,
                        descricao TEXT,
                        imagem_url TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // Tabela equipe
                    `CREATE TABLE IF NOT EXISTS equipe (
                        id SERIAL PRIMARY KEY,
                        nome TEXT NOT NULL,
                        funcao TEXT,
                        foto_url TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // Tabela redes_sociais
                    `CREATE TABLE IF NOT EXISTS redes_sociais (
                        id SERIAL PRIMARY KEY,
                        nome_rede TEXT NOT NULL,
                        link TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // Tabela site_conteudo
                    `CREATE TABLE IF NOT EXISTS site_conteudo (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        secao TEXT NOT NULL,
                        conteudo_html TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`
                ];

                // Executar cada comando
                for (let i = 0; i < sqlCommands.length; i++) {
                    const sql = sqlCommands[i];
                    const tableName = sql.match(/CREATE TABLE IF NOT EXISTS (\w+)/)[1];
                    
                    addLog(`Criando tabela: ${tableName}...`);
                    
                    const { error } = await supabase.rpc('exec_sql', { sql_command: sql });
                    
                    if (error) {
                        // Tenta m√©todo alternativo usando supabase-js
                        addLog(`M√©todo RPC falhou, tentando m√©todo alternativo para ${tableName}...`);
                        
                        // Como n√£o podemos executar DDL diretamente, vamos usar a API de administra√ß√£o
                        throw new Error(`N√£o √© poss√≠vel criar tabelas via JavaScript. Use o painel do Supabase.`);
                    }
                    
                    addLog(`‚úÖ Tabela ${tableName} criada com sucesso!`);
                }
                
                addLog('üéâ Todas as tabelas foram criadas com sucesso!');
                showStatus('Todas as tabelas foram criadas com sucesso!', 'success');
                
            } catch (error) {
                addLog('‚ùå Erro ao criar tabelas: ' + error.message);
                showStatus('Para criar as tabelas, acesse o SQL Editor do Supabase e execute o arquivo supabase-setup.sql', 'error');
            } finally {
                createTablesBtn.disabled = false;
                createTablesBtn.textContent = 'üöÄ Criar Todas as Tabelas';
            }
        }

        async function insertSampleData() {
            insertSampleDataBtn.disabled = true;
            insertSampleDataBtn.textContent = 'üîÑ Inserindo...';
            
            try {
                addLog('Inserindo dados de exemplo...');
                
                // Inserir dados em painel_site
                const { error: painelError } = await supabase
                    .from('painel_site')
                    .insert({
                        title: 'Liberdade & Desenvolvimento',
                        subtitle: 'Vereador Emicleiton Rubem da Concei√ß√£o',
                        about_text: 'Trabalhando pela transforma√ß√£o de Monte Santo com transpar√™ncia, dedica√ß√£o e compromisso com o povo.',
                        contact_whatsapp: '(74) 99999-9999',
                        contact_email: 'contato@emicleiton.com.br'
                    });
                
                if (painelError) throw painelError;
                addLog('‚úÖ Dados do painel inseridos!');
                
                // Inserir dados em site_conteudo
                const { error: conteudoError } = await supabase
                    .from('site_conteudo')
                    .insert([
                        {
                            secao: 'cabecalho',
                            conteudo_html: '<h1>Liberdade & Desenvolvimento</h1><h2>Vereador Emicleiton Rubem da Concei√ß√£o</h2><p>Monte Santo - BA</p>'
                        },
                        {
                            secao: 'biografia',
                            conteudo_html: '<p>Nascido em Monte Santo, Emicleiton Rubem da Concei√ß√£o √© um vereador comprometido com o desenvolvimento de sua cidade.</p>'
                        }
                    ]);
                
                if (conteudoError) throw conteudoError;
                addLog('‚úÖ Conte√∫do do site inserido!');
                
                // Inserir dados em agenda_publica
                const { error: agendaError } = await supabase
                    .from('agenda_publica')
                    .insert([
                        {
                            titulo: 'Sess√£o Ordin√°ria da C√¢mara',
                            descricao: 'Reuni√£o ordin√°ria para discuss√£o de projetos em tramita√ß√£o',
                            data: '2025-01-30'
                        },
                        {
                            titulo: 'Audi√™ncia P√∫blica - Or√ßamento',
                            descricao: 'Discuss√£o do or√ßamento municipal para 2025',
                            data: '2025-02-15'
                        }
                    ]);
                
                if (agendaError) throw agendaError;
                addLog('‚úÖ Agenda p√∫blica inserida!');
                
                addLog('üéâ Todos os dados de exemplo foram inseridos com sucesso!');
                showStatus('Dados de exemplo inseridos com sucesso!', 'success');
                
            } catch (error) {
                addLog('‚ùå Erro ao inserir dados: ' + error.message);
                showStatus('Erro ao inserir dados: ' + error.message, 'error');
            } finally {
                insertSampleDataBtn.disabled = false;
                insertSampleDataBtn.textContent = 'üìã Inserir Dados de Exemplo';
            }
        }

        // Event listeners
        testConnectionBtn.addEventListener('click', testConnection);
        createTablesBtn.addEventListener('click', createTables);
        insertSampleDataBtn.addEventListener('click', insertSampleData);

        // Test connection automatically
        window.addEventListener('load', testConnection);
    </script>
</body>
</html>